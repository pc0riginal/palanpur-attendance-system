{% extends 'base.html' %}
{% load attendance_tags %}

{% block title %}Mark Attendance - Temple Attendance{% endblock %}

{% block content %}
<div class="mb-4" data-aos="fade-down">
    <h2 class="fw-bold mb-3"><i class="bi bi-check-circle text-success"></i> Mark Attendance</h2>
    <div class="card">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="fw-semibold mb-2">{{ sabha.get_sabha_type_display }}</h5>
                    <div class="row text-muted small">
                        <div class="col-sm-4 mb-1">
                            <i class="bi bi-calendar3 me-2"></i>{{ sabha.date }}
                        </div>
                        <div class="col-sm-4 mb-1">
                            <i class="bi bi-clock me-2"></i>{{ sabha.start_time }} - {{ sabha.end_time }}
                        </div>
                        <div class="col-sm-4 mb-1">
                            <i class="bi bi-geo-alt me-2"></i>{{ sabha.location }}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <span class="badge bg-light text-dark px-3 py-2 fs-6">{{ total_count }} Devotees</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <div class="row">
        <div class="col-md-3">
            <select id="searchType" class="form-select">
                <option value="id" {% if request.GET.search_type == 'id' or not request.GET.search_type %}selected{% endif %}>Search by ID</option>
                <option value="name" {% if request.GET.search_type == 'name' %}selected{% endif %}>Search by Name</option>
                <option value="phone" {% if request.GET.search_type == 'phone' %}selected{% endif %}>Search by Phone</option>
                <option value="type" {% if request.GET.search_type == 'type' %}selected{% endif %}>Search by Type</option>
            </select>
        </div>
        <div class="col-md-9">
            <input type="text" id="searchInput" class="form-control" placeholder="Enter search term..." value="{{ search_query }}">
        </div>
    </div>
    <div id="searchLoading" class="text-center mt-2" style="display: none;">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span class="ms-2">Searching...</span>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            {% if devotees %}
                <!-- Mobile Cards -->
                <div class="d-block d-lg-none">
                    {% for devotee in devotees %}
                        <div class="card mb-3" data-aos="fade-up" data-aos-delay="{% cycle '50' '100' '150' '200' '250' %}">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="me-3">
                                        {% if devotee.photo_url %}
                                            <img src="{{ devotee.photo_url }}" alt="{{ devotee.name }}" 
                                                 class="rounded-circle" width="60" height="60" 
                                                 style="object-fit: cover;" 
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="bg-light rounded-circle d-none align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="bi bi-person fs-5"></i>
                                            </div>
                                        {% else %}
                                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                <i class="bi bi-person fs-5"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h6 class="fw-semibold mb-1">{{ devotee.name }}</h6>
                                        <small class="text-muted d-block">ID: {{ devotee.devotee_id }} | {{ devotee.contact_number }}</small>
                                        <small class="text-muted">{{ devotee.get_sabha_type_display }} | {{ devotee.devotee_type|title }}</small>
                                    </div>
                                </div>
                                
                                <!-- Status Toggle Buttons -->
                                <div class="btn-group w-100 mb-3" role="group">
                                    <input type="radio" class="btn-check" name="status_{{ devotee.id }}" id="present_{{ devotee.id }}" value="present" onchange="saveAttendance('{{ devotee.id }}', 'present')" {% with existing_attendance|get_item:devotee.id as attendance %}{% if attendance.status == 'present' %}checked{% endif %}{% endwith %}>
                                    <label class="btn btn-outline-success" for="present_{{ devotee.id }}">
                                        <i class="bi bi-check-circle"></i> Present
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="status_{{ devotee.id }}" id="late_{{ devotee.id }}" value="late" onchange="saveAttendance('{{ devotee.id }}', 'late')" {% with existing_attendance|get_item:devotee.id as attendance %}{% if attendance.status == 'late' %}checked{% endif %}{% endwith %}>
                                    <label class="btn btn-outline-warning" for="late_{{ devotee.id }}">
                                        <i class="bi bi-clock"></i> Late
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="status_{{ devotee.id }}" id="absent_{{ devotee.id }}" value="absent" onchange="saveAttendance('{{ devotee.id }}', 'absent')" {% with existing_attendance|get_item:devotee.id as attendance %}{% if not attendance or attendance.status == 'absent' %}checked{% endif %}{% endwith %}>
                                    <label class="btn btn-outline-danger" for="absent_{{ devotee.id }}">
                                        <i class="bi bi-x-circle"></i> Absent
                                    </label>
                                </div>
                                
                                <input type="text" name="notes_{{ devotee.id }}" class="form-control" 
                                       value="{% with existing_attendance|get_item:devotee.id as attendance %}{% if attendance %}{{ attendance.notes }}{% endif %}{% endwith %}" 
                                       placeholder="Add notes (optional)" 
                                       onchange="saveNotes({{ devotee.id }}, this.value)">
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Desktop Table -->
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>ID</th>
                                    <th>Devotee Name</th>
                                    <th>Contact</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for devotee in devotees %}
                                    <tr>
                                        <td>
                                            {% if devotee.photo_url %}
                                                <img src="{{ devotee.photo_url }}" alt="{{ devotee.name }}" 
                                                     class="rounded-circle" width="40" height="40" 
                                                     style="object-fit: cover;" 
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                <div class="rounded-circle bg-light d-none align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="bi bi-person text-muted"></i>
                                                </div>
                                            {% else %}
                                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    <i class="bi bi-person text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>{{ devotee.devotee_id }}</td>
                                        <td>{{ devotee.name }}</td>
                                        <td>{{ devotee.contact_number }}</td>
                                        <td>
                                            <select name="status_{{ devotee.id }}" class="form-select form-select-sm" onchange="saveAttendance('{{ devotee.id }}', this.value)">
                                                {% with existing_attendance|get_item:devotee.id as attendance %}
                                                <option value="absent" {% if not attendance or attendance.status == 'absent' %}selected{% endif %}>Absent</option>
                                                <option value="present" {% if attendance.status == 'present' %}selected{% endif %}>Present</option>
                                                <option value="late" {% if attendance.status == 'late' %}selected{% endif %}>Late</option>
                                                {% endwith %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" name="notes_{{ devotee.id }}" class="form-control form-control-sm" 
                                                   value="{% with existing_attendance|get_item:devotee.id as attendance %}{% if attendance %}{{ attendance.notes }}{% endif %}{% endwith %}" 
                                                   placeholder="Optional notes" 
                                                   onchange="saveNotes({{ devotee.id }}, this.value)">
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Pagination -->
                {% if page_obj.paginator.num_pages > 1 %}
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">&laquo; First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                            </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                        </li>
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Last &raquo;</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
                <div class="d-flex justify-content-center mt-3">
                    <a href="{% url 'sabha_list' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Sabhas
                    </a>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No devotees found for this sabha type.</p>
                    <a href="{% url 'devotee_add' %}" class="btn btn-temple">Add Devotees</a>
                </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- Save Status -->
<div id="saveStatus" class="position-fixed" style="top: 80px; right: 20px; z-index: 1000; display: none;">
    <div class="alert alert-success alert-sm mb-0 shadow-sm">
        <i class="bi bi-check-circle"></i> <span id="saveMessage">Saved</span>
    </div>
</div>

<script>
// Simple save attendance function
function saveAttendance(devoteeId, status) {
    const sabhaId = window.location.pathname.split('/')[2];
    const notesElement = document.querySelector(`[name="notes_${devoteeId}"]`);
    
    console.log('Saving attendance:', devoteeId, status, sabhaId);
    
    const data = {
        sabha_id: sabhaId,
        devotee_id: String(devoteeId),
        status: status,
        notes: notesElement ? notesElement.value : ''
    };
    
    showSaveStatus('Saving...', 'warning');
    
    fetch('/api/save-attendance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSaveStatus('Saved', 'success');
        } else {
            showSaveStatus('Save failed', 'danger');
        }
    })
    .catch(error => {
        showSaveStatus('Save failed', 'danger');
    });
}

// Save notes function
function saveNotes(devoteeId, notes) {
    const sabhaId = window.location.pathname.split('/')[2];
    devoteeId = String(devoteeId);
    const statusElement = document.querySelector(`[name="status_${devoteeId}"]`);
    
    // Get current status
    let currentStatus = 'absent';
    if (statusElement) {
        if (statusElement.type === 'radio') {
            const checkedRadio = document.querySelector(`[name="status_${devoteeId}"]:checked`);
            if (checkedRadio) currentStatus = checkedRadio.value;
        } else {
            currentStatus = statusElement.value;
        }
    }
    
    const data = {
        sabha_id: sabhaId,
        devotee_id: String(devoteeId),
        status: currentStatus,
        notes: notes
    };
    
    showSaveStatus('Saving notes...', 'warning');
    
    fetch('/api/save-attendance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSaveStatus('Notes saved', 'success');
        } else {
            showSaveStatus('Notes save failed', 'danger');
        }
    })
    .catch(error => {
        showSaveStatus('Notes save failed', 'danger');
    });
}





// Show save status
function showSaveStatus(message, type) {
    const status = document.getElementById('saveStatus');
    const messageEl = document.getElementById('saveMessage');
    const alertEl = status.querySelector('.alert');
    
    messageEl.textContent = message;
    alertEl.className = `alert alert-${type} alert-sm mb-0 shadow-sm`;
    status.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            status.style.display = 'none';
        }, 1500);
    }
}



// Server-side search functionality
let searchTimeout;
function performAttendanceSearch() {
    const searchTerm = document.getElementById('searchInput').value;
    const searchType = document.getElementById('searchType').value;
    const loading = document.getElementById('searchLoading');
    
    clearTimeout(searchTimeout);
    loading.style.display = 'block';
    
    searchTimeout = setTimeout(() => {
        const url = new URL(window.location);
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
            url.searchParams.set('search_type', searchType);
        } else {
            url.searchParams.delete('search');
            url.searchParams.delete('search_type');
        }
        url.searchParams.delete('page');
        
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            updateAttendanceList(data);
            updateAttendancePagination(data);
            loading.style.display = 'none';
        })
        .catch(() => {
            loading.style.display = 'none';
        });
    }, 300);
}

document.getElementById('searchInput').addEventListener('input', performAttendanceSearch);
document.getElementById('searchType').addEventListener('change', performAttendanceSearch);

function updateAttendanceList(data) {
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    const desktopContainer = document.querySelector('.d-none.d-md-block tbody');
    
    mobileContainer.innerHTML = '';
    desktopContainer.innerHTML = '';
    
    data.devotees.forEach(devotee => {
        const mobileCard = document.createElement('div');
        mobileCard.className = 'card mb-3';
        mobileCard.innerHTML = `
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        ${devotee.photo_url ? 
                            `<img src="${devotee.photo_url}" alt="${devotee.name}" class="rounded-circle" width="60" height="60" style="object-fit: cover;">` :
                            `<div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-person fs-5"></i></div>`
                        }
                    </div>
                    <div>
                        <h6 class="fw-semibold mb-1">${devotee.name}</h6>
                        <small class="text-muted d-block">ID: ${devotee.devotee_id} | ${devotee.contact_number}</small>
                        <small class="text-muted">${devotee.sabha_type_display} | ${devotee.devotee_type ? devotee.devotee_type.charAt(0).toUpperCase() + devotee.devotee_type.slice(1) : 'N/A'}</small>
                    </div>
                </div>
                <div class="btn-group w-100 mb-3" role="group">
                    <input type="radio" class="btn-check" name="status_${devotee.id}" id="present_${devotee.id}" value="present" onchange="saveAttendance('${devotee.id}', 'present')">
                    <label class="btn btn-outline-success" for="present_${devotee.id}"><i class="bi bi-check-circle"></i> Present</label>
                    <input type="radio" class="btn-check" name="status_${devotee.id}" id="late_${devotee.id}" value="late" onchange="saveAttendance('${devotee.id}', 'late')">
                    <label class="btn btn-outline-warning" for="late_${devotee.id}"><i class="bi bi-clock"></i> Late</label>
                    <input type="radio" class="btn-check" name="status_${devotee.id}" id="absent_${devotee.id}" value="absent" onchange="saveAttendance('${devotee.id}', 'absent')" checked>
                    <label class="btn btn-outline-danger" for="absent_${devotee.id}"><i class="bi bi-x-circle"></i> Absent</label>
                </div>
                <input type="text" name="notes_${devotee.id}" class="form-control" placeholder="Add notes (optional)" onchange="saveNotes('${devotee.id}', this.value)">
            </div>
        `;
        mobileContainer.appendChild(mobileCard);
        
        const desktopRow = document.createElement('tr');
        desktopRow.innerHTML = `
            <td>
                ${devotee.photo_url ? 
                    `<img src="${devotee.photo_url}" alt="${devotee.name}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">` :
                    `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-person text-muted"></i></div>`
                }
            </td>
            <td>${devotee.name}</td>
            <td>${devotee.contact_number}</td>
            <td>
                <select name="status_${devotee.id}" class="form-select form-select-sm" onchange="saveAttendance('${devotee.id}', this.value)">
                    <option value="absent" selected>Absent</option>
                    <option value="present">Present</option>
                    <option value="late">Late</option>
                </select>
            </td>
            <td>
                <input type="text" name="notes_${devotee.id}" class="form-control form-control-sm" placeholder="Optional notes" onchange="saveNotes('${devotee.id}', this.value)">
            </td>
        `;
        desktopContainer.appendChild(desktopRow);
    });
}

function updateAttendancePagination(data) {
    const paginationNav = document.querySelector('nav');
    if (!paginationNav || data.total_pages <= 1) {
        if (paginationNav) paginationNav.style.display = 'none';
        return;
    }
    
    paginationNav.style.display = 'block';
    const pagination = paginationNav.querySelector('.pagination');
    
    let paginationHTML = '';
    
    if (data.has_previous) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadAttendancePage(1)">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadAttendancePage(${data.current_page - 1})">Previous</a>
            </li>
        `;
    }
    
    paginationHTML += `
        <li class="page-item active">
            <span class="page-link">Page ${data.current_page} of ${data.total_pages}</span>
        </li>
    `;
    
    if (data.has_next) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadAttendancePage(${data.current_page + 1})">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadAttendancePage(${data.total_pages})">Last &raquo;</a>
            </li>
        `;
    }
    
    pagination.innerHTML = paginationHTML;
}

function loadAttendancePage(page) {
    const searchQuery = document.getElementById('searchInput').value;
    const sabhaId = window.location.pathname.split('/')[2];
    const url = `/sabhas/${sabhaId}/attendance/?page=${page}${searchQuery ? '&search=' + searchQuery : ''}`;
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        updateAttendanceList(data);
        updateAttendancePagination(data);
    });
}

function createMobileAttendanceCard(devotee) {
    const card = document.createElement('div');
    card.className = 'card mb-3';
    card.innerHTML = `
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    ${devotee.photo_url ? 
                        `<img src="${devotee.photo_url}" alt="${devotee.name}" class="rounded-circle" width="60" height="60" style="object-fit: cover;">` :
                        `<div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-person fs-5"></i></div>`
                    }
                </div>
                <div>
                    <h6 class="fw-semibold mb-1">${devotee.name}</h6>
                    <small class="text-muted d-block">${devotee.contact_number}</small>
                    <small class="text-muted">${devotee.sabha_type_display}</small>
                </div>
            </div>
            <div class="btn-group w-100 mb-3" role="group">
                <input type="radio" class="btn-check" name="status_${devotee.id}" id="present_${devotee.id}" value="present" ${devotee.attendance_status === 'present' ? 'checked' : ''}>
                <label class="btn btn-outline-success" for="present_${devotee.id}"><i class="bi bi-check-circle"></i> Present</label>
                <input type="radio" class="btn-check" name="status_${devotee.id}" id="late_${devotee.id}" value="late" ${devotee.attendance_status === 'late' ? 'checked' : ''}>
                <label class="btn btn-outline-warning" for="late_${devotee.id}"><i class="bi bi-clock"></i> Late</label>
                <input type="radio" class="btn-check" name="status_${devotee.id}" id="absent_${devotee.id}" value="absent" ${devotee.attendance_status === 'absent' ? 'checked' : ''}>
                <label class="btn btn-outline-danger" for="absent_${devotee.id}"><i class="bi bi-x-circle"></i> Absent</label>
            </div>
            <input type="text" name="notes_${devotee.id}" class="form-control" value="${devotee.attendance_notes}" placeholder="Add notes (optional)">
        </div>
    `;
    return card;
}

function createDesktopAttendanceRow(devotee) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            ${devotee.photo_url ? 
                `<img src="${devotee.photo_url}" alt="${devotee.name}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">` :
                `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-person text-muted"></i></div>`
            }
        </td>
        <td>${devotee.name}</td>
        <td>${devotee.contact_number}</td>
        <td>
            <select name="status_${devotee.id}" class="form-select form-select-sm">
                <option value="absent" ${devotee.attendance_status === 'absent' ? 'selected' : ''}>Absent</option>
                <option value="present" ${devotee.attendance_status === 'present' ? 'selected' : ''}>Present</option>
                <option value="late" ${devotee.attendance_status === 'late' ? 'selected' : ''}>Late</option>
            </select>
        </td>
        <td>
            <input type="text" name="notes_${devotee.id}" class="form-control form-control-sm" value="${devotee.attendance_notes}" placeholder="Optional notes">
        </td>
    `;
    return row;
}
</script>
{% endblock %}