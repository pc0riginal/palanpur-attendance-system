{% extends 'base.html' %}

{% block title %}{{ title }} - Temple Attendance{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-user"></i> {{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Devotee ID</label>
                                <input type="text" name="devotee_id" class="form-control" value="{{ devotee.devotee_id|default:'' }}" placeholder="Auto-generated if empty">
                                <div class="form-text">Leave empty for auto-generation</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Devotee Type</label>
                                <select name="devotee_type" class="form-select" required>
                                    <option value="haribhakt" {% if devotee.devotee_type == 'haribhakt' %}selected{% endif %}>Haribhakt</option>
                                    <option value="gunbhavi" {% if devotee.devotee_type == 'gunbhavi' %}selected{% endif %}>Gunbhavi</option>
                                    <option value="karyakar" {% if devotee.devotee_type == 'karyakar' %}selected{% endif %}>Karyakar</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" name="name" class="form-control" value="{{ devotee.name|default:'' }}" required minlength="2" maxlength="100">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Contact Number</label>
                                <input type="tel" name="contact_number" class="form-control" value="{{ devotee.contact_number|default:'' }}" required pattern="[0-9]{10}" maxlength="10" title="Enter 10 digit mobile number">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" name="date_of_birth" class="form-control" value="{{ devotee.date_of_birth|default:'' }}" required id="dobInput" max="{{ today }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Gender</label>
                                <select name="gender" class="form-select" required>
                                    <option value="">Select Gender</option>
                                    <option value="male" {% if devotee.gender == 'male' %}selected{% endif %}>Male</option>
                                    <option value="female" {% if devotee.gender == 'female' %}selected{% endif %}>Female</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Age</label>
                                <input type="number" name="age" class="form-control" value="{{ devotee.age|default:'' }}" readonly id="ageInput">
                                <div class="form-text">Auto-calculated from date of birth</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sabha Type</label>
                                <select name="sabha_type" class="form-select" required>
                                    <option value="bal" {% if devotee.sabha_type == 'bal' %}selected{% endif %}>Bal Sabha</option>
                                    <option value="yuvak" {% if devotee.sabha_type == 'yuvak' %}selected{% endif %}>Yuvak Sabha</option>
                                    <option value="mahila" {% if devotee.sabha_type == 'mahila' %}selected{% endif %}>Mahila Sabha</option>
                                    <option value="sanyukt" {% if devotee.sabha_type == 'sanyukt' %}selected{% endif %}>Sanyukt Sabha</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address Line</label>
                        <input type="text" name="address_line" class="form-control" value="{{ devotee.address_line|default:'' }}" placeholder="House/Flat No, Street Name" accept-charset="UTF-8">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Landmark</label>
                                <input type="text" name="landmark" class="form-control" value="{{ devotee.landmark|default:'' }}" placeholder="Near landmark" accept-charset="UTF-8">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Zone</label>
                                <input type="text" name="zone" class="form-control" value="{{ devotee.zone|default:'' }}" placeholder="Area/Zone" accept-charset="UTF-8">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Photo</label>
                        <input type="file" name="photo" class="form-control" accept="image/*" capture="camera" id="photoInput">
                        <input type="hidden" name="cropped_photo" id="croppedPhotoInput">
                        <div class="form-text">Upload or take a photo from camera</div>
                        {% if devotee.photo_url %}
                            <div class="mt-2">
                                <img src="{{ devotee.photo_url }}" alt="Current Photo" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                <div class="form-text">Current photo</div>
                            </div>
                        {% endif %}
                        <div id="photoPreview" class="mt-2" style="display: none;">
                            <img id="previewImg" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                            <div class="form-text">Cropped photo preview</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Join Date</label>
                        <input type="date" name="join_date" class="form-control" value="{{ devotee.join_date|default:'' }}" max="{{ today }}" required>
                    </div>
                    <div class="d-flex flex-column flex-sm-row justify-content-between gap-2">
                        <a href="{% url 'devotee_list' %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-temple" id="saveBtn">
                            <span id="saveText">Save Devotee</span>
                            <span id="saveLoader" class="d-none">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Saving...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Photo Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crop Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <small class="text-muted">Position the circle to frame the face properly. The photo will be cropped as a circle.</small>
                </div>
                <div class="crop-container" style="max-height: 400px; overflow: hidden;">
                    <img id="cropImage" style="max-width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-temple" id="cropBtn">Crop & Use</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<style>
.cropper-crop-box {
    border-radius: 50% !important;
    border: 2px solid #6C63FF !important;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5) !important;
}
.cropper-face {
    border-radius: 50% !important;
    background-color: rgba(108, 99, 255, 0.1) !important;
}
.cropper-view-box {
    outline: none !important;
}
#previewImg {
    border-radius: 50% !important;
    border: 3px solid #6C63FF;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script>
let cropper;

// Photo input change - show crop modal
document.getElementById('photoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('cropImage').src = e.target.result;
            
            // Show crop modal
            const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
            cropModal.show();
            
            // Initialize cropper when modal is shown
            document.getElementById('cropModal').addEventListener('shown.bs.modal', function() {
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(document.getElementById('cropImage'), {
                    aspectRatio: 1, // Square ratio for circle
                    viewMode: 1,
                    autoCropArea: 0.6,
                    responsive: true,
                    background: false,
                    guides: false,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    ready: function() {
                        // Add circular overlay
                        const cropBox = document.querySelector('.cropper-crop-box');
                        if (cropBox) {
                            cropBox.style.borderRadius = '50%';
                            cropBox.style.overflow = 'hidden';
                        }
                        const face = document.querySelector('.cropper-face');
                        if (face) {
                            face.style.borderRadius = '50%';
                        }
                    }
                });
            }, { once: true });
        };
        reader.readAsDataURL(file);
    }
});

// Crop button click
document.getElementById('cropBtn').addEventListener('click', function() {
    if (cropper) {
        const canvas = cropper.getCroppedCanvas({
            width: 300,
            height: 300,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });
        
        // Create circular canvas
        const circularCanvas = document.createElement('canvas');
        const ctx = circularCanvas.getContext('2d');
        circularCanvas.width = 300;
        circularCanvas.height = 300;
        
        // Create circular clipping path
        ctx.beginPath();
        ctx.arc(150, 150, 150, 0, 2 * Math.PI);
        ctx.clip();
        
        // Draw the cropped image
        ctx.drawImage(canvas, 0, 0, 300, 300);
        
        // Convert circular canvas to blob and show preview
        circularCanvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const previewImg = document.getElementById('previewImg');
            previewImg.src = url;
            previewImg.style.borderRadius = '50%';
            document.getElementById('photoPreview').style.display = 'block';
            
            // Convert to base64 for form submission
            const reader = new FileReader();
            reader.onload = function() {
                document.getElementById('croppedPhotoInput').value = reader.result;
            };
            reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.9);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('cropModal')).hide();
    }
});

// Clean up cropper when modal is hidden
document.getElementById('cropModal').addEventListener('hidden.bs.modal', function() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
});

// Age calculation from date of birth
document.getElementById('dobInput').addEventListener('change', function() {
    const dob = new Date(this.value);
    const today = new Date();
    
    if (dob > today) {
        alert('Date of birth cannot be in the future!');
        this.value = '';
        document.getElementById('ageInput').value = '';
        return;
    }
    
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    
    document.getElementById('ageInput').value = age >= 0 ? age : '';
});

// Form submission loader
document.querySelector('form').addEventListener('submit', function() {
    const saveBtn = document.getElementById('saveBtn');
    const saveText = document.getElementById('saveText');
    const saveLoader = document.getElementById('saveLoader');
    
    saveBtn.disabled = true;
    saveText.classList.add('d-none');
    saveLoader.classList.remove('d-none');
});

// Calculate age on page load if DOB exists
window.addEventListener('load', function() {
    const dobInput = document.getElementById('dobInput');
    if (dobInput.value) {
        dobInput.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}