{% extends 'base.html' %}

{% block title %}Devotees - Temple Attendance{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4><i class="bi bi-people"></i> <span class="d-none d-sm-inline">Devotees</span></h4>
        <small class="text-muted">{{ total_count }} total devotees</small>
    </div>
    <a href="{% url 'devotee_add' %}" class="btn btn-temple btn-sm">
        <i class="bi bi-plus"></i> Add
    </a>
</div>

<div class="mb-3">
    <div class="row">
        <div class="col-md-3">
            <select id="searchType" class="form-select">
                <option value="id" {% if request.GET.search_type == 'id' or not request.GET.search_type %}selected{% endif %}>Search by ID</option>
                <option value="name" {% if request.GET.search_type == 'name' %}selected{% endif %}>Search by Name</option>
                <option value="phone" {% if request.GET.search_type == 'phone' %}selected{% endif %}>Search by Phone</option>
                <option value="type" {% if request.GET.search_type == 'type' %}selected{% endif %}>Search by Type</option>
            </select>
        </div>
        <div class="col-md-9">
            <input type="text" id="searchInput" class="form-control" placeholder="Enter search term..." value="{{ search_query }}">
        </div>
    </div>
    <div id="searchLoading" class="text-center mt-2" style="display: none;">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span class="ms-2">Searching...</span>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if page_obj %}
            <!-- Mobile Cards -->
            <div class="d-block d-md-none">
                {% for devotee in page_obj %}
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex align-items-center mb-2">
                                <div class="me-2">
                                    {% if devotee.photo_url %}
                                        <img src="{{ devotee.photo_url }}" alt="{{ devotee.name }}" 
                                             class="rounded-circle" width="40" height="40" 
                                             style="object-fit: cover;" 
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="rounded-circle bg-light d-none align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="bi bi-person text-muted"></i>
                                        </div>
                                    {% else %}
                                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="bi bi-person text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 fw-semibold">{{ devotee.name }}</h6>
                                    <small class="text-muted">ID: {{ devotee.devotee_id|default:"N/A" }} | {{ devotee.contact_number }}</small>
                                    <div class="mt-1">
                                        <span class="badge bg-light text-dark me-1" style="font-size: 0.7rem;">{{ devotee.get_sabha_type_display }}</span>
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">{{ devotee.devotee_type|default:"N/A"|title }}</span>
                                    </div>
                                </div>
                                <div class="d-flex flex-column gap-1">
                                    <a href="{% url 'devotee_detail' devotee.id %}" class="btn btn-sm btn-outline-primary" style="width: 32px; height: 28px; padding: 0;"><i class="bi bi-eye" style="font-size: 0.8rem;"></i></a>
                                    <a href="{% url 'devotee_edit' devotee.id %}" class="btn btn-sm btn-outline-primary" style="width: 32px; height: 28px; padding: 0;"><i class="bi bi-pencil" style="font-size: 0.8rem;"></i></a>
                                    <button class="btn btn-sm btn-outline-danger" style="width: 32px; height: 28px; padding: 0;" onclick="confirmDelete('devotee', '{{ devotee.id }}', '{{ devotee.name }}')"><i class="bi bi-trash" style="font-size: 0.8rem;"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Desktop Table -->
            <div class="d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>Sabha Type</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for devotee in page_obj %}
                                <tr>
                                    <td>
                                        {% if devotee.photo_url %}
                                            <img src="{{ devotee.photo_url }}" alt="{{ devotee.name }}" 
                                                 class="rounded-circle" width="40" height="40" 
                                                 style="object-fit: cover;" 
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="rounded-circle bg-light d-none align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="bi bi-person text-muted"></i>
                                            </div>
                                        {% else %}
                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="bi bi-person text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>{{ devotee.devotee_id }}</td>
                                    <td>{{ devotee.name }}</td>
                                    <td>{{ devotee.contact_number }}</td>
                                    <td>{{ devotee.get_sabha_type_display }}</td>
                                    <td>{{ devotee.devotee_type|title }}</td>
                                    <td>
                                        <div class="d-flex gap-1 align-items-center">
                                            <a href="{% url 'devotee_detail' devotee.id %}" class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 32px;">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{% url 'devotee_edit' devotee.id %}" class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center" style="width: 40px; height: 32px;">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center" style="width: 40px; height: 32px;" onclick="confirmDelete('devotee', '{{ devotee.id }}', '{{ devotee.name }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <p class="text-muted">No devotees found. <a href="{% url 'devotee_add' %}">Add the first devotee</a>.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}&search_type={{ request.GET.search_type }}{% endif %}">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}&search_type={{ request.GET.search_type }}{% endif %}">Previous</a>
            </li>
        {% endif %}
        
        <li class="page-item active">
            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>
        
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}&search_type={{ request.GET.search_type }}{% endif %}">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}&search_type={{ request.GET.search_type }}{% endif %}">Last &raquo;</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
let searchTimeout;
function performSearch() {
    const searchTerm = document.getElementById('searchInput').value;
    const searchType = document.getElementById('searchType').value;
    const loading = document.getElementById('searchLoading');
    
    clearTimeout(searchTimeout);
    loading.style.display = 'block';
    
    searchTimeout = setTimeout(() => {
        const url = new URL(window.location);
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
            url.searchParams.set('search_type', searchType);
            url.searchParams.delete('page');
        } else {
            url.searchParams.delete('search');
            url.searchParams.delete('search_type');
            // Keep current page when clearing search
        }
        
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            updateDevoteeList(data);
            updatePagination(data);
            loading.style.display = 'none';
        })
        .catch(() => {
            loading.style.display = 'none';
        });
    }, 300);
}

document.getElementById('searchInput').addEventListener('input', performSearch);
document.getElementById('searchType').addEventListener('change', performSearch);


function updateDevoteeList(data) {
    const mobileContainer = document.querySelector('.d-block.d-md-none');
    const desktopContainer = document.querySelector('.d-none.d-md-block tbody');
    
    mobileContainer.innerHTML = '';
    desktopContainer.innerHTML = '';
    
    data.devotees.forEach(devotee => {
        const mobileCard = document.createElement('div');
        mobileCard.className = 'card mb-2';
        mobileCard.innerHTML = `
            <div class="card-body p-2">
                <div class="d-flex align-items-center mb-2">
                    <div class="me-2">
                        ${devotee.photo_url ? 
                            `<img src="${devotee.photo_url}" alt="${devotee.name}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">` :
                            `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-person text-muted"></i></div>`
                        }
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0 fw-semibold">${devotee.name}</h6>
                        <small class="text-muted">ID: ${devotee.devotee_id} | ${devotee.contact_number}</small>
                        <div class="mt-1">
                            <span class="badge bg-light text-dark me-1" style="font-size: 0.7rem;">${devotee.sabha_type_display}</span>
                            <span class="badge bg-secondary" style="font-size: 0.7rem;">${devotee.devotee_type ? devotee.devotee_type.charAt(0).toUpperCase() + devotee.devotee_type.slice(1) : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="d-flex flex-column gap-1">
                        <a href="/devotees/${devotee.id}/" class="btn btn-sm btn-outline-primary" style="width: 32px; height: 28px; padding: 0;"><i class="bi bi-eye" style="font-size: 0.8rem;"></i></a>
                        <a href="/devotees/edit/${devotee.id}/" class="btn btn-sm btn-outline-primary" style="width: 32px; height: 28px; padding: 0;"><i class="bi bi-pencil" style="font-size: 0.8rem;"></i></a>
                        <button class="btn btn-sm btn-outline-danger" style="width: 32px; height: 28px; padding: 0;" onclick="confirmDelete('devotee', '${devotee.id}', '${devotee.name}')"><i class="bi bi-trash" style="font-size: 0.8rem;"></i></button>
                    </div>
                </div>
            </div>
        `;
        mobileContainer.appendChild(mobileCard);
        
        const desktopRow = document.createElement('tr');
        desktopRow.innerHTML = `
            <td>
                ${devotee.photo_url ? 
                    `<img src="${devotee.photo_url}" alt="${devotee.name}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">` :
                    `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-person text-muted"></i></div>`
                }
            </td>
            <td>${devotee.devotee_id}</td>
            <td>${devotee.name}</td>
            <td>${devotee.contact_number}</td>
            <td>${devotee.sabha_type_display}</td>
            <td>${devotee.devotee_type ? devotee.devotee_type.charAt(0).toUpperCase() + devotee.devotee_type.slice(1) : 'N/A'}</td>
            <td>
                <div class="d-flex gap-2">
                    <a href="/devotees/${devotee.id}/" class="btn btn-sm btn-outline-primary" style="width: 40px; height: 32px;"><i class="bi bi-eye"></i></a>
                    <a href="/devotees/edit/${devotee.id}/" class="btn btn-sm btn-outline-primary" style="width: 40px; height: 32px;"><i class="bi bi-pencil"></i></a>
                    <button class="btn btn-sm btn-outline-danger" style="width: 40px; height: 32px;" onclick="confirmDelete('devotee', '${devotee.id}', '${devotee.name}')"><i class="bi bi-trash"></i></button>
                </div>
            </td>
        `;
        desktopContainer.appendChild(desktopRow);
    });
    
    document.querySelector('.text-muted').textContent = `${data.total_count} total devotees`;
}

function updatePagination(data) {
    const paginationNav = document.querySelector('nav');
    if (!paginationNav) return;
    
    if (data.total_pages <= 1) {
        paginationNav.style.display = 'none';
        return;
    }
    
    paginationNav.style.display = 'block';
    const pagination = paginationNav.querySelector('.pagination');
    const searchQuery = document.getElementById('searchInput').value;
    
    let paginationHTML = '';
    
    if (data.has_previous) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadPage(1)">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadPage(${data.current_page - 1})">Previous</a>
            </li>
        `;
    }
    
    paginationHTML += `
        <li class="page-item active">
            <span class="page-link">Page ${data.current_page} of ${data.total_pages}</span>
        </li>
    `;
    
    if (data.has_next) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadPage(${data.current_page + 1})">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadPage(${data.total_pages})">Last &raquo;</a>
            </li>
        `;
    }
    
    pagination.innerHTML = paginationHTML;
}

function loadPage(page) {
    const searchQuery = document.getElementById('searchInput').value;
    const searchType = document.getElementById('searchType').value;
    const url = new URL(window.location);
    url.searchParams.set('page', page);
    if (searchQuery) {
        url.searchParams.set('search', searchQuery);
        url.searchParams.set('search_type', searchType);
    }
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        updateDevoteeList(data);
        updatePagination(data);
    });
}

function confirmDelete(type, id, name) {
    document.getElementById('deleteModalTitle').textContent = `Delete ${type.charAt(0).toUpperCase() + type.slice(1)}`;
    document.getElementById('deleteModalBody').innerHTML = `Are you sure you want to delete <strong>"${name}"</strong>?<br><small class="text-muted">This action cannot be undone and will delete all related records.</small>`;
    document.getElementById('confirmDeleteBtn').onclick = function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/${type}s/delete/${id}/`;
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';
        form.appendChild(csrfToken);
        
        document.body.appendChild(form);
        form.submit();
    };
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalTitle">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deleteModalBody">
                Are you sure you want to delete this item?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
