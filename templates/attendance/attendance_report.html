{% extends 'base.html' %}

{% block title %}Attendance Reports - Temple Attendance{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="fas fa-chart-line"></i> <span class="d-none d-sm-inline">Reports & Analytics</span></h4>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
            <i class="bi bi-bar-chart"></i> Analytics
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">
            <i class="bi bi-table"></i> Report
        </button>
    </li>
</ul>

<div class="tab-content" id="reportTabContent">

<!-- Analytics Tab -->
<div class="tab-pane fade show active" id="analytics" role="tabpanel">
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-bar-chart"></i> Attendance by Sabha Type</h6>
                </div>
                <div class="card-body">
                    <canvas id="sabhaBarChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-pie-chart"></i> Attendance Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="sabhaPieChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-12 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-graph-up"></i> Monthly Attendance Trend</h6>
                </div>
                <div class="card-body">
                    <canvas id="monthlyLineChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Tab -->
<div class="tab-pane fade" id="report" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="bi bi-table"></i> Attendance Report</h5>
        <a href="{% url 'export_attendance' %}{% if filters.sabha_type or filters.date_from or filters.date_to %}?{% if filters.sabha_type %}sabha_type={{ filters.sabha_type }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% endif %}" class="btn btn-temple btn-sm">
            <i class="bi bi-download me-2"></i> Export
        </a>
    </div>
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-filter"></i> Filters</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-2" id="filterForm">
                <input type="hidden" name="tab" value="report">
                <div class="col-12 col-md-4">
                    <label for="sabha_type" class="form-label small">Sabha Type</label>
                    <select name="sabha_type" id="sabha_type" class="form-select form-select-sm">
                        <option value="">All Sabha Types</option>
                        {% for value, label in sabha_types %}
                            <option value="{{ value }}" {% if filters.sabha_type == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <label for="date_from" class="form-label small">From Date</label>
                    <input type="date" name="date_from" id="date_from" class="form-control form-control-sm" value="{{ filters.date_from }}">
                </div>
                <div class="col-6 col-md-3">
                    <label for="date_to" class="form-label small">To Date</label>
                    <input type="date" name="date_to" id="date_to" class="form-control form-control-sm" value="{{ filters.date_to }}">
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label small d-none d-md-block">&nbsp;</label>
                    <button type="submit" class="btn btn-temple w-100 btn-sm">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Status Buttons -->
    <div class="row mb-4">
        <div class="col-md-4 mb-2">
            <a href="?tab=report&{% if filters.sabha_type %}sabha_type={{ filters.sabha_type }}&{% endif %}{% if filters.date_from %}date_from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}date_to={{ filters.date_to }}&{% endif %}status=present" 
               class="btn {% if filters.status == 'present' %}btn-success{% else %}btn-outline-success{% endif %} w-100">
                <i class="bi bi-check-circle"></i> Present ({{ present_count }})
            </a>
        </div>
        <div class="col-md-4 mb-2">
            <a href="?tab=report&{% if filters.sabha_type %}sabha_type={{ filters.sabha_type }}&{% endif %}{% if filters.date_from %}date_from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}date_to={{ filters.date_to }}&{% endif %}status=absent" 
               class="btn {% if filters.status == 'absent' %}btn-danger{% else %}btn-outline-danger{% endif %} w-100">
                <i class="bi bi-x-circle"></i> Absent ({{ absent_count }})
            </a>
        </div>
        <div class="col-md-4 mb-2">
            <a href="?tab=report&{% if filters.sabha_type %}sabha_type={{ filters.sabha_type }}&{% endif %}{% if filters.date_from %}date_from={{ filters.date_from }}&{% endif %}{% if filters.date_to %}date_to={{ filters.date_to }}&{% endif %}status=late" 
               class="btn {% if filters.status == 'late' %}btn-warning{% else %}btn-outline-warning{% endif %} w-100">
                <i class="bi bi-clock"></i> Late ({{ late_count }})
            </a>
        </div>
    </div>

    {% if filters.status %}
    <div class="mb-3">
        <input type="text" id="reportSearchInput" class="form-control" placeholder="Search devotees by name..." value="{{ search_query }}">
        <div id="reportSearchLoading" class="text-center mt-2" style="display: none;">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span class="ms-2">Searching...</span>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body">
            {% if page_obj %}
                <!-- Mobile Cards -->
                <div class="d-block d-md-none">
                    {% for record in page_obj %}
                        <div class="card mb-2">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ record.devotee_name }}</h6>
                                        <small class="text-muted d-block">{{ record.sabha_type|title }} Sabha</small>
                                        <small class="text-muted d-block">{{ record.sabha_date }}</small>
                                        {% if record.notes %}<small class="text-muted">{{ record.notes }}</small>{% endif %}
                                    </div>
                                    <span class="badge {% if record.status == 'present' %}bg-success{% elif record.status == 'late' %}bg-warning{% else %}bg-danger{% endif %} px-3 py-2">
                                        <i class="bi {% if record.status == 'present' %}bi-check-circle{% elif record.status == 'late' %}bi-clock{% else %}bi-x-circle{% endif %} me-1"></i>
                                        {{ record.status|title }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Desktop Table -->
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Devotee</th>
                                    <th>Sabha Type</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in page_obj %}
                                    <tr>
                                        <td>{{ record.devotee_name }}</td>
                                        <td>{{ record.sabha_type|title }} Sabha</td>
                                        <td>{{ record.sabha_date }}</td>
                                        <td>
                                            <span class="badge {% if record.status == 'present' %}bg-success{% elif record.status == 'late' %}bg-warning{% else %}bg-danger{% endif %} px-3 py-2">
                                                <i class="bi {% if record.status == 'present' %}bi-check-circle{% elif record.status == 'late' %}bi-clock{% else %}bi-x-circle{% endif %} me-1"></i>
                                                {{ record.status|title }}
                                            </span>
                                        </td>
                                        <td>{{ record.notes|default:"-" }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pagination -->
                {% if page_obj.paginator.num_pages > 1 %}
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?tab=report&page=1{% if filters.sabha_type %}&sabha_type={{ filters.sabha_type }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">&laquo; First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?tab=report&page={{ page_obj.previous_page_number }}{% if filters.sabha_type %}&sabha_type={{ filters.sabha_type }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                            </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                        </li>
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?tab=report&page={{ page_obj.next_page_number }}{% if filters.sabha_type %}&sabha_type={{ filters.sabha_type }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?tab=report&page={{ page_obj.paginator.num_pages }}{% if filters.sabha_type %}&sabha_type={{ filters.sabha_type }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Last &raquo;</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No attendance records found for the selected filters.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

</div>

<script>
let reportSearchTimeout;
document.addEventListener('DOMContentLoaded', function() {
    // Re-attach search listener when tab is shown
    document.getElementById('report-tab')?.addEventListener('shown.bs.tab', function() {
        attachReportSearch();
    });
    
    // Initial attachment
    attachReportSearch();
});

function attachReportSearch() {
    const reportSearchInput = document.getElementById('reportSearchInput');
    if (reportSearchInput) {
        reportSearchInput.removeEventListener('input', handleReportSearch);
        reportSearchInput.addEventListener('input', handleReportSearch);
    }
}

function handleReportSearch() {
    const searchTerm = this.value;
    const loading = document.getElementById('reportSearchLoading');
    
    clearTimeout(reportSearchTimeout);
    if (loading) loading.style.display = 'block';
    
    reportSearchTimeout = setTimeout(() => {
                // Only search if a status is selected
                const currentUrl = new URL(window.location);
                if (!currentUrl.searchParams.get('status')) {
                    if (loading) loading.style.display = 'none';
                    return;
                }
                
                const url = new URL(window.location);
                url.searchParams.set('tab', 'report');
                if (searchTerm) {
                    url.searchParams.set('search', searchTerm);
                } else {
                    url.searchParams.delete('search');
                }
                url.searchParams.delete('page');
                
                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Search data:', data); // Debug log
                    if (data.records !== undefined) {
                        // Update the report content directly
                        const mobileContainer = document.querySelector('#report .d-block.d-md-none');
                        const desktopContainer = document.querySelector('#report .d-none.d-md-block tbody');
                        
                        if (mobileContainer) {
                            mobileContainer.innerHTML = '';
                            data.records.forEach(record => {
                                const statusClass = record.status === 'present' ? 'bg-success' : record.status === 'late' ? 'bg-warning' : 'bg-danger';
                                const statusIcon = record.status === 'present' ? 'bi-check-circle' : record.status === 'late' ? 'bi-clock' : 'bi-x-circle';
                                
                                const card = document.createElement('div');
                                card.className = 'card mb-2';
                                card.innerHTML = `
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">${record.devotee_name}</h6>
                                                <small class="text-muted d-block">${record.sabha_type.charAt(0).toUpperCase() + record.sabha_type.slice(1)} Sabha</small>
                                                <small class="text-muted d-block">${record.sabha_date}</small>
                                                ${record.notes ? `<small class="text-muted">${record.notes}</small>` : ''}
                                            </div>
                                            <span class="badge ${statusClass} px-3 py-2">
                                                <i class="bi ${statusIcon} me-1"></i>
                                                ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                                            </span>
                                        </div>
                                    </div>
                                `;
                                mobileContainer.appendChild(card);
                            });
                        }
                        
                        if (desktopContainer) {
                            desktopContainer.innerHTML = '';
                            data.records.forEach(record => {
                                const statusClass = record.status === 'present' ? 'bg-success' : record.status === 'late' ? 'bg-warning' : 'bg-danger';
                                const statusIcon = record.status === 'present' ? 'bi-check-circle' : record.status === 'late' ? 'bi-clock' : 'bi-x-circle';
                                
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${record.devotee_name}</td>
                                    <td>${record.sabha_type.charAt(0).toUpperCase() + record.sabha_type.slice(1)} Sabha</td>
                                    <td>${record.sabha_date}</td>
                                    <td>
                                        <span class="badge ${statusClass} px-3 py-2">
                                            <i class="bi ${statusIcon} me-1"></i>
                                            ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                                        </span>
                                    </td>
                                    <td>${record.notes || '-'}</td>
                                `;
                                desktopContainer.appendChild(row);
                            });
                        }
                        
                        updateReportPagination(data);
                    }
                    if (loading) loading.style.display = 'none';
                })
                .catch(() => {
                    if (loading) loading.style.display = 'none';
                });
    }, 300);
}

function updateReportList(data) {
    const mobileContainer = document.querySelector('#report .d-block.d-md-none');
    const desktopContainer = document.querySelector('#report .d-none.d-md-block tbody');
    
    if (!mobileContainer || !desktopContainer) return;
    
    mobileContainer.innerHTML = '';
    desktopContainer.innerHTML = '';
    
    data.records.forEach(record => {
        const statusClass = record.status === 'present' ? 'bg-success' : record.status === 'late' ? 'bg-warning' : 'bg-danger';
        const statusIcon = record.status === 'present' ? 'bi-check-circle' : record.status === 'late' ? 'bi-clock' : 'bi-x-circle';
        
        const mobileCard = document.createElement('div');
        mobileCard.className = 'card mb-2';
        mobileCard.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${record.devotee_name}</h6>
                        <small class="text-muted d-block">${record.sabha_type.charAt(0).toUpperCase() + record.sabha_type.slice(1)} Sabha</small>
                        <small class="text-muted d-block">${record.sabha_date}</small>
                        ${record.notes ? `<small class="text-muted">${record.notes}</small>` : ''}
                    </div>
                    <span class="badge ${statusClass} px-3 py-2">
                        <i class="bi ${statusIcon} me-1"></i>
                        ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                    </span>
                </div>
            </div>
        `;
        mobileContainer.appendChild(mobileCard);
        
        const desktopRow = document.createElement('tr');
        desktopRow.innerHTML = `
            <td>${record.devotee_name}</td>
            <td>${record.sabha_type.charAt(0).toUpperCase() + record.sabha_type.slice(1)} Sabha</td>
            <td>${record.sabha_date}</td>
            <td>
                <span class="badge ${statusClass} px-3 py-2">
                    <i class="bi ${statusIcon} me-1"></i>
                    ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                </span>
            </td>
            <td>${record.notes || '-'}</td>
        `;
        desktopContainer.appendChild(desktopRow);
    });
}

function updateReportPagination(data) {
    const paginationNav = document.querySelector('#report nav');
    if (!paginationNav || data.total_pages <= 1) {
        if (paginationNav) paginationNav.style.display = 'none';
        return;
    }
    
    paginationNav.style.display = 'block';
    const pagination = paginationNav.querySelector('.pagination');
    
    let paginationHTML = '';
    
    if (data.has_previous) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadReportPage(1)">&laquo; First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadReportPage(${data.current_page - 1})">Previous</a>
            </li>
        `;
    }
    
    paginationHTML += `
        <li class="page-item active">
            <span class="page-link">Page ${data.current_page} of ${data.total_pages}</span>
        </li>
    `;
    
    if (data.has_next) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadReportPage(${data.current_page + 1})">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadReportPage(${data.total_pages})">Last &raquo;</a>
            </li>
        `;
    }
    
    pagination.innerHTML = paginationHTML;
}

function loadReportPage(page) {
    const searchQuery = document.getElementById('searchInput')?.value || '';
    const url = new URL(window.location);
    url.searchParams.set('tab', 'report');
    url.searchParams.set('page', page);
    if (searchQuery) {
        url.searchParams.set('search', searchQuery);
    }
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        updateReportList(data);
        updateReportPagination(data);
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let barChart, pieChart, lineChart;

function loadCharts() {
    const params = new URLSearchParams(window.location.search);
    const url = '{% url "attendance_analytics" %}?' + params.toString();
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            createBarChart(data.sabha_counts);
            createPieChart(data.sabha_counts);
            createLineChart(data.monthly_trend);
        })
        .catch(error => console.error('Error loading charts:', error));
}

function createBarChart(sabhaData) {
    const ctx = document.getElementById('sabhaBarChart');
    if (barChart) barChart.destroy();
    
    const labels = Object.keys(sabhaData).map(k => k.charAt(0).toUpperCase() + k.slice(1));
    const values = Object.values(sabhaData);
    
    barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.length ? labels : ['No Data'],
            datasets: [{
                label: 'Attendance Count',
                data: values.length ? values : [0],
                backgroundColor: [
                    'rgba(108, 99, 255, 0.8)',
                    'rgba(0, 194, 255, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ],
                borderColor: [
                    'rgba(108, 99, 255, 1)',
                    'rgba(0, 194, 255, 1)',
                    'rgba(16, 185, 129, 1)',
                    'rgba(245, 158, 11, 1)'
                ],
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(17, 20, 57, 0.9)',
                    padding: 12,
                    borderRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
}

function createPieChart(sabhaData) {
    const ctx = document.getElementById('sabhaPieChart');
    if (pieChart) pieChart.destroy();
    
    const labels = Object.keys(sabhaData).map(k => k.charAt(0).toUpperCase() + k.slice(1));
    const values = Object.values(sabhaData);
    
    pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.length ? labels : ['No Data'],
            datasets: [{
                data: values.length ? values : [1],
                backgroundColor: [
                    'rgba(108, 99, 255, 0.8)',
                    'rgba(0, 194, 255, 0.8)',
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ],
                borderColor: '#fff',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(17, 20, 57, 0.9)',
                    padding: 12,
                    borderRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1000
            }
        }
    });
}

function createLineChart(monthlyData) {
    const ctx = document.getElementById('monthlyLineChart');
    if (lineChart) lineChart.destroy();
    
    const labels = Object.keys(monthlyData);
    const values = Object.values(monthlyData);
    
    lineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels.length ? labels : ['No Data'],
            datasets: [{
                label: 'Monthly Attendance',
                data: values.length ? values : [0],
                borderColor: 'rgba(108, 99, 255, 1)',
                backgroundColor: 'rgba(108, 99, 255, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: 'rgba(108, 99, 255, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(17, 20, 57, 0.9)',
                    padding: 12,
                    borderRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 5 }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', loadCharts);

document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const params = new URLSearchParams(formData);
    params.set('tab', 'report');
    params.delete('status'); // Clear status filter when applying date/sabha filters
    
    // Update URL without reload
    window.history.pushState({}, '', '?' + params.toString());
    
    // Fetch filtered data
    fetch(window.location.href, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update status button counts
        updateStatusButtons(data);
        // Clear current report data
        clearReportData();
        loadCharts();
    })
    .catch(() => {
        location.reload(); // Fallback to reload on error
    });
});

function updateStatusButtons(data) {
    const presentBtn = document.querySelector('a[href*="status=present"]');
    const absentBtn = document.querySelector('a[href*="status=absent"]');
    const lateBtn = document.querySelector('a[href*="status=late"]');
    
    if (presentBtn) presentBtn.innerHTML = `<i class="bi bi-check-circle"></i> Present (${data.present_count})`;
    if (absentBtn) absentBtn.innerHTML = `<i class="bi bi-x-circle"></i> Absent (${data.absent_count})`;
    if (lateBtn) lateBtn.innerHTML = `<i class="bi bi-clock"></i> Late (${data.late_count})`;
    
    // Update button URLs with new filters
    const baseParams = new URLSearchParams(window.location.search);
    baseParams.delete('status');
    baseParams.delete('page');
    
    if (presentBtn) {
        const presentParams = new URLSearchParams(baseParams);
        presentParams.set('status', 'present');
        presentBtn.href = '?' + presentParams.toString();
    }
    if (absentBtn) {
        const absentParams = new URLSearchParams(baseParams);
        absentParams.set('status', 'absent');
        absentBtn.href = '?' + absentParams.toString();
    }
    if (lateBtn) {
        const lateParams = new URLSearchParams(baseParams);
        lateParams.set('status', 'late');
        lateBtn.href = '?' + lateParams.toString();
    }
}

function clearReportData() {
    const mobileContainer = document.querySelector('#report .d-block.d-md-none');
    const desktopContainer = document.querySelector('#report .d-none.d-md-block tbody');
    const paginationNav = document.querySelector('#report nav');
    
    if (mobileContainer) mobileContainer.innerHTML = '<div class="text-center py-4"><p class="text-muted">Select a status to view records</p></div>';
    if (desktopContainer) desktopContainer.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Select a status to view records</td></tr>';
    if (paginationNav) paginationNav.style.display = 'none';
}

// Handle tab switching
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    
    if (activeTab === 'report') {
        document.getElementById('analytics-tab').classList.remove('active');
        document.getElementById('report-tab').classList.add('active');
        document.getElementById('analytics').classList.remove('show', 'active');
        document.getElementById('report').classList.add('show', 'active');
    }
});
</script>
{% endblock %}
